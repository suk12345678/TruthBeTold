name: iOS Build (Free - No EAS)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'simulator'
        type: choice
        options:
          - simulator
          - device

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-14

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./mobile
        run: npm ci

      - name: ğŸ”‘ Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: ğŸ“± Prebuild iOS project
        working-directory: ./mobile
        run: |
          npx expo prebuild --platform ios --clean
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install CocoaPods dependencies
        working-directory: ./mobile/ios
        run: |
          pod install

      - name: ğŸ—ï¸ Build iOS Simulator
        if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == ''
        working-directory: ./mobile/ios
        run: |
          xcodebuild \
            -workspace TruthBeTold.xcworkspace \
            -scheme TruthBeTold \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -derivedDataPath build \
            build

      - name: ğŸ“¦ Create Simulator Archive
        if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == ''
        working-directory: ./mobile/ios
        run: |
          cd build/Build/Products/Debug-iphonesimulator
          zip -r TruthBeTold-simulator.app.zip TruthBeTold.app

      - name: ğŸ“¤ Upload Simulator Build
        if: github.event.inputs.build_type == 'simulator' || github.event.inputs.build_type == ''
        uses: actions/upload-artifact@v4
        with:
          name: TruthBeTold-iOS-Simulator-${{ github.sha }}
          path: mobile/ios/build/Build/Products/Debug-iphonesimulator/TruthBeTold-simulator.app.zip
          retention-days: 30

      - name: ğŸ“Š Build Summary
        run: |
          echo "âœ… iOS build completed successfully!"
          echo "ğŸ“± Build type: ${{ github.event.inputs.build_type || 'simulator' }}"
          echo "ğŸ”— Download artifacts from the Actions tab"
          echo ""
          echo "To install on simulator:"
          echo "1. Download the .app.zip file"
          echo "2. Unzip it"
          echo "3. Drag TruthBeTold.app to your iOS Simulator"

